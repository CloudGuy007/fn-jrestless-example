version: 2
jobs:
  build:
    working_directory: ~/fn-jrestless
    machine:
      java:
        version: oraclejdk8
    environment:
    steps:
      - checkout
      - run:
           name: Set release to latest branch version
           command: |
               git checkout origin/${CIRCLE_BRANCH} release.version
               echo next release version is $(cat release.version)
      - run:
           name: Determine the release version
           command: ./.circleci/update-versions.sh
      - run:
          name: Build and test
          command: |
            mvn verify
      - store_test_results:
          path: handler/target/surefire-reports
      - store_test_results:
          path: blogging-example/target/surefire-reports
      - deploy:
          name: Release new version (if master)
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              git config --global user.email "ci@fnproject.com"
              git config --global user.name "CI"
              git branch --set-upstream-to=origin/${CIRCLE_BRANCH} ${CIRCLE_BRANCH}
              ./.circleci/release.sh
            fi

